{% extends "base.html" %}
{% block content %}
<div class="well">
    <form id="id_form" class="form-horizontal">
        <fieldset>
            <div class="form-group">
                <label for="id_name" class="col-sm-2 control-label">Name:</label>

                <div class="col-sm-4">
                    <input type="text" class="form-control" id="id_name" placeholder="Name">
                </div>
            </div>
            <div class="form-group">
                <label for="id_gender" class="col-sm-2 control-label">Gender:</label>

                <div class="col-sm-4">
                    <select name="gender" class="form-control" id="id_gender">
                        <option value="0">Male</option>
                        <option value="1">Female</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="id_disable" class="col-sm-2 control-label">Disable:</label>

                <div class="col-sm-4">
                    <input type="checkbox" class="form-control" id="id_disable" checked/>
                </div>
            </div>
            <div class="form-group">
                <label for="id_lastlogin" class="col-sm-2 control-label">LastLogin:</label>

                <div class="col-sm-4">
                    <div class='input-group date' id='dp_lastlogin'>
                        <input type='text' id="id_lastlogin" class="form-control"/>
                    <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span>
                    </span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="col-sm-4 col-sm-offset-2">
                    <button id="btn_query" class="btn btn-primary" type="button">Query</button>
                </div>
            </div>
        </fieldset>
    </form>
</div>
<p id="p_criteria"></p>

{% include 'dj-mongo-reader/table.html' %}


<div class="modal fade" id="tDetail">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Detail</h4>
            </div>
            <div class="modal-body">
                <table border="0"
                       class="table table-striped table-bordered bootstrap-datatable datatable table-condensed"
                       id="tbl_detail">
                    <thead>
                    <th>Field</th>
                    <th>Value</th>
                    </thead>
                    <tbody>

                    </tbody>

                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% block dj-mongo-rest-extra-js %}
<script>
    $(function () {

        $('#dp_lastlogin').datetimepicker({
            format: 'YYYY-MM-DD'
        });


        $('#btn_query').bind('click', function (e) {
            var _criteria = {}, _sort = {}, $temp;
            e.preventDefault();

            $temp = $('#id_name').val();
            if ($temp) {
                _criteria.name = $temp;
            }

            $temp = $('#id_lastlogin').val();
            if ($temp) {
                _criteria.lastlogin = {"$gte": $temp};
            }

            _criteria.gender = (+$('#id_gender').val());
            _criteria.disable = ($('#id_disable:checked').length ? true : false);

            window.criteria = _criteria;
            window.sort = _sort;

            $('#p_criteria').html('Criteria:' + JSON.stringify(_criteria));
            RenderTable.getCount();
            RenderTable.getMongoData(1);
        });

        window.gender_process = function (val) {
            return (val ? 'Female' : 'Male');
        };

        window.disable_process = function (val) {
            return (val ? '<span class="glyphicon glyphicon-ok" aria-hidden="true"></span>' : '<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>');
        };

        window._id_process = function (val) {
            return (typeof val === 'object' ? val.$oid : val);
        };

        function detailClickFun(e) {
            var _detailData4tpe = [], _detailData;
            e.preventDefault();
            _detailData = $(this).attr('detaildata');

            if (_detailData) {
                _detailData = $.parseJSON(_detailData);
                $.each(_detailData, function (k1, v1) {
                    var tr = {};
                    tr.thead = k1;
                    if (RenderTable.columns_trans.hasOwnProperty(k1)) {
                        tr.thead = RenderTable.columns_trans[k1];
                    }

                    tr.content = v1;
                    if (window.hasOwnProperty(k1 + '_process')) {
                        /*jslint evil: true */
                        tr.content = eval(k1 + '_process')(v1);
                    }

                    _detailData4tpe.push('<tr><td>' + tr.thead + '</td><td>' + tr.content + '</td></tr>');
                });

                //sort detail field by field name
                Array.prototype.sort.call(_detailData4tpe, function (a, b) {
                    return a.thead > b.thead;
                });
                $('#tbl_detail tbody').html(_detailData4tpe.join(''));
                $('#tDetail').modal('show');
            }
        };

        $('#tbl_mongo').off('click', 'a.detail').on('click', 'a.detail', detailClickFun);
    });
</script>
{% endblock %}
{% endblock %}
